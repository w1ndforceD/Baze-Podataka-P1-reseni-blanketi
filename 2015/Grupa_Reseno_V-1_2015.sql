--Kod za tabele--
--1)--
Create table PROIZVOD(
    SIFRA_PROIZVODA int primary key not null,
    CENA int not null,
    NAZIV_PROIZVODA varchar(30) not null,
    NAZIV_PROIZVODJACA varchar(30) not null,
    DATUM_PROIZVODNJE date not null,
    DATUM_ISTEKA date not null,
    Check(DATUM_ISTEKA>DATUM_PROIZVODNJE)
);

CREATE TABLE TRAFIKA
(
    ID_T int PRIMARY KEY,
    NAZIV VARCHAR(35) NOT NULL,
    ADRESA VARCHAR(50) NOT NULL,
    TELEFON VARCHAR(30),
    DAT_POS DATE
);

CREATE TABLE PRODAJE
(
    ID_TRAFIKE int CONSTRAINT ID_TRAFIKE_FK REFERENCES TRAFIKA,
    ID_PROIZVODA int CONSTRAINT ID_PROIZVODA_FK REFERENCES PROIZVOD,
    KOLICINA int,
    CONSTRAINT PRODAJE_PK PRIMARY KEY (ID_TRAFIKE,ID_PROIZVODA,KOLICINA)
);

--Podaci--
INSERT INTO PROIZVOD VALUES(100101,56,'Smoki','Stark','03-NOV-2014','03-APR-2015');
INSERT INTO PROIZVOD VALUES(100102,12,'Bananica','Stark','15-FEB-2014','18-JAN-2015');
INSERT INTO PROIZVOD VALUES(100103,125,'Sok Kruska','Next','15-DEC-2014','15-DEC-2015');
INSERT INTO PROIZVOD VALUES(100104,125,'Sok Jagoda','Next','15-DEC-2014','15-DEC-2015');
INSERT INTO PROIZVOD VALUES(100105,75.5,'Cips','Stark','03-NOV-2014','03-NOV-2015');
INSERT INTO PROIZVOD VALUES(100106,75,'Cips','KPlus','15-NOV-2014','15-NOV-2015');
INSERT INTO PROIZVOD VALUES(100107,120,'C kafa','Centro proizvod','18-DEC-2014','18-DEC-2015');
INSERT INTO PROIZVOD VALUES(100108,100,'Coko plazma','Bambi','18-DEC-2013','18-DEC-2015');
INSERT INTO PROIZVOD VALUES(100109,95.5,'Plazma','Bambi','20-DEC-2013','20-DEC-2015');
INSERT INTO PROIZVOD VALUES(100110,97.5,'Posna plazma','Bambi','25-DEC-2013','25-DEC-2015');
INSERT INTO PROIZVOD VALUES(100111,120,'Napolitanke','Stark','15-MAY-2013','15-MAY-2015');

INSERT INTO TRAFIKA VALUES(1,'Anabela','Vase Carapica 18','018/888-999','12-DEC-2000');
INSERT INTO TRAFIKA VALUES(2,'KK Trade','Jovna Babica 15','018/221-758','8-JAN-2003');
INSERT INTO TRAFIKA VALUES(3,'Sunce','Carnojevica 21','018/221-758','15-NOV-2004');
INSERT INTO TRAFIKA VALUES(4,'Jorgovan','Vase Pelagica 58','018/122-365','03-JAN-2000');
INSERT INTO TRAFIKA VALUES(5,'Sunce 1','Karadjordjeva 15','018/544-366','18-APR-1989');
INSERT INTO TRAFIKA VALUES(6,'Ruza','Vase Pelagica 98','018/511-289','03-DEC-2008');
INSERT INTO TRAFIKA VALUES(7,'Kosta','Vaska Pope 12','018/122-444','17-JAN-2006');

INSERT INTO PRODAJE VALUES(1,100101,50);
INSERT INTO PRODAJE VALUES(2,100101,20);
INSERT INTO PRODAJE VALUES(3,100101,18);
INSERT INTO PRODAJE VALUES(4,100101,35);
INSERT INTO PRODAJE VALUES(5,100101,40);
INSERT INTO PRODAJE VALUES(6,100101,70);

INSERT INTO PRODAJE VALUES(1,100102,10);
INSERT INTO PRODAJE VALUES(2,100102,150);
INSERT INTO PRODAJE VALUES(3,100102,20);
INSERT INTO PRODAJE VALUES(4,100102,80);
INSERT INTO PRODAJE VALUES(5,100102,70);
INSERT INTO PRODAJE VALUES(6,100102,15);

INSERT INTO PRODAJE VALUES(7,100103,110);
INSERT INTO PRODAJE VALUES(6,100103,120);
INSERT INTO PRODAJE VALUES(3,100103,11);
INSERT INTO PRODAJE VALUES(4,100103,18);
INSERT INTO PRODAJE VALUES(5,100103,25);
INSERT INTO PRODAJE VALUES(6,100103,78);

INSERT INTO PRODAJE VALUES(5,100104,150);
INSERT INTO PRODAJE VALUES(7,100104,150);
INSERT INTO PRODAJE VALUES(3,100104,15);
INSERT INTO PRODAJE VALUES(4,100104,15);
INSERT INTO PRODAJE VALUES(1,100104,25);
INSERT INTO PRODAJE VALUES(6,100104,75);

INSERT INTO PRODAJE VALUES(5,100105,20);
INSERT INTO PRODAJE VALUES(7,100105,20);
INSERT INTO PRODAJE VALUES(3,100105,28);
INSERT INTO PRODAJE VALUES(4,100105,28);
INSERT INTO PRODAJE VALUES(1,100105,28);
INSERT INTO PRODAJE VALUES(6,100105,87);

INSERT INTO PRODAJE VALUES(1,100106,120);
INSERT INTO PRODAJE VALUES(2,100106,150);
INSERT INTO PRODAJE VALUES(3,100106,120);
INSERT INTO PRODAJE VALUES(4,100106,45);
INSERT INTO PRODAJE VALUES(5,100106,53);
INSERT INTO PRODAJE VALUES(7,100106,10);

INSERT INTO PRODAJE VALUES(1,100107,120);
INSERT INTO PRODAJE VALUES(2,100107,150);
INSERT INTO PRODAJE VALUES(3,100107,120);
INSERT INTO PRODAJE VALUES(4,100107,15);
INSERT INTO PRODAJE VALUES(5,100107,13);
INSERT INTO PRODAJE VALUES(7,100107,10);

INSERT INTO PRODAJE VALUES(1,100108,50);
INSERT INTO PRODAJE VALUES(5,100108,70);
INSERT INTO PRODAJE VALUES(3,100108,31);
INSERT INTO PRODAJE VALUES(4,100108,32);
INSERT INTO PRODAJE VALUES(2,100108,38);
INSERT INTO PRODAJE VALUES(6,100108,39);

INSERT INTO PRODAJE VALUES(1,100109,20);
INSERT INTO PRODAJE VALUES(5,100109,20);
INSERT INTO PRODAJE VALUES(3,100109,21);
INSERT INTO PRODAJE VALUES(4,100109,22);
INSERT INTO PRODAJE VALUES(2,100109,28);
INSERT INTO PRODAJE VALUES(6,100109,29);

INSERT INTO PRODAJE VALUES(1,100110,90);
INSERT INTO PRODAJE VALUES(5,100110,90);
INSERT INTO PRODAJE VALUES(3,100110,91);
INSERT INTO PRODAJE VALUES(4,100110,92);
INSERT INTO PRODAJE VALUES(2,100110,98);
INSERT INTO PRODAJE VALUES(6,100110,99);

INSERT INTO PRODAJE VALUES(1,100111,90);
INSERT INTO PRODAJE VALUES(5,100111,120);
INSERT INTO PRODAJE VALUES(3,100111,121);
INSERT INTO PRODAJE VALUES(4,100111,122);
INSERT INTO PRODAJE VALUES(2,100111,128);
INSERT INTO PRODAJE VALUES(6,100111,129);
INSERT INTO PRODAJE VALUES(7,100111,50);

--2)Napisati SQL upit koji prikazuje šifru proizvoda, naziv, i cenu proizvoda čiji je proizvođač ‘Bambi’ i proizvedeni su u 2013 godini. Sortirati rezultate prema ceni u opadajući redosled (10 poena)--

--1. resenje:-- 
SELECT SIFRA_PROIZVODA, NAZIV_PROIZVODA, CENA
FROM PROIZVOD
WHERE NAZIV_PROIZVODJACA='Bambi' AND
DATUM_PROIZVODNJE >=  '01-JAN-2013' AND 
DATUM_PROIZVODNJE <=  '31-DEC-2013' 
ORDER BY CENA DESC

--2. resenje (ORACLE)--
SELECT SIFRA_PROIZVODA, NAZIV_PROIZVODA, CENA
FROM PROIZVOD
WHERE NAZIV_PROIZVODJACA = 'Bambi'
  AND DATUM_PROIZVODNJE BETWEEN DATE '2013-01-01' AND DATE '2013-12-31'
ORDER BY CENA DESC;

--3. resenje lakse (ORACLE)--
SELECT SIFRA_PROIZVODA, NAZIV_PROIZVODA, CENA
FROM PROIZVOD
WHERE NAZIV_PROIZVODJACA = 'Bambi'
  AND EXTRACT(YEAR FROM DATUM_PROIZVODNJE) = 2013
ORDER BY CENA DESC;

--3)Kreirati upit koji za svaki proizvod koji nije u roku trajanja prikazuje naziv, cenu i količinu na stanju u trafici ‘Anabela’. Sortirati rezultate prema ceni u rastući redosled. (15 poena)
SELECT D.NAZIV_PROIZVODA, D.CENA, P.KOLICINA
FROM PRODAJE P, PROIZVOD D, TRAFIKA T
WHERE D.SIFRA_PROIZVODA=P.ID_PROIZVODA and
T.ID_T=P.ID_TRAFIKE and
T.NAZIV='Anabela' and
D.DATUM_ISTEKA<SYSDATE
order by D.CENA ASC

--4)Prikazati nazive trafika koje imaju tačno 4 različitih artikala čiji je proizvođač ‘Stark’ i nemaju proizvode čiji je proizvođač ‘Centro proizvod’. (15 poena) 
SELECT t.naziv
FROM trafika t
WHERE
    -- tačno 4 različita artikla proizvođača 'Stark'
    (SELECT COUNT(DISTINCT pr.sifra_proizvoda)
     FROM prodaje p
     JOIN proizvod pr ON pr.sifra_proizvoda = p.id_proizvoda
     WHERE p.id_trafike = t.id_t
       AND pr.naziv_proizvodjaca = 'Stark'
    ) = 4
    -- i nemaju nijedan proizvod proizvođača 'Centro proizvod'
    AND NOT EXISTS (
        SELECT 1
        FROM prodaje p2
        JOIN proizvod pr2 ON pr2.sifra_proizvoda = p2.id_proizvoda
        WHERE p2.id_trafike = t.id_t
          AND pr2.naziv_proizvodjaca = 'Centro proizvod'
    );

--5)Prikazati trafike koje prodaju najmanje različitih proizvoda . (20 poena) 
SELECT t.naziv
FROM trafika t
JOIN prodaje p ON p.id_trafike = t.id_t
GROUP BY t.id_t, t.naziv
HAVING COUNT(DISTINCT p.id_proizvoda) = (
    SELECT MIN(cnt)
    FROM (
        SELECT COUNT(DISTINCT p2.id_proizvoda) AS cnt
        FROM prodaje p2
        GROUP BY p2.id_trafike
    )

);
-- test
